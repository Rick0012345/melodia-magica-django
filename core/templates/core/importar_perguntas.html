{% extends 'core/admin_base.html' %}
{% load static %}

{% block page_title %}Importar Perguntas{% endblock %}
{% block page_subtitle %}Importar perguntas de planilhas Excel ou CSV{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'quiz_list' %}">Quizzes</a></li>
{% if quiz %}
<li class="breadcrumb-item"><a href="{% url 'pergunta_list' quiz.id %}">{{ quiz.titulo }}</a></li>
{% endif %}
<li class="breadcrumb-item active">Importar Perguntas</li>
{% endblock %}

{% block extra_css %}
<style>
.import-card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    overflow: hidden;
}

.import-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem;
    text-align: center;
}

.format-example {
    background: #f8f9fa;
    border: 2px dashed #dee2e6;
    border-radius: 10px;
    padding: 1.5rem;
    margin: 1rem 0;
}

.format-table {
    font-size: 0.9rem;
    margin-bottom: 0;
}

.format-table th {
    background: #e9ecef;
    font-weight: 600;
    text-align: center;
    padding: 0.5rem;
    font-size: 0.8rem;
}

.format-table td {
    padding: 0.5rem;
    text-align: center;
    border: 1px solid #dee2e6;
}

.upload-zone {
    border: 3px dashed #dee2e6;
    border-radius: 15px;
    padding: 3rem 2rem;
    text-align: center;
    transition: all 0.3s ease;
    background: #f8f9fa;
}

.upload-zone:hover {
    border-color: #667eea;
    background: #f0f4ff;
}

.upload-zone.dragover {
    border-color: #667eea;
    background: #e3f2fd;
}

.btn-download-template {
    background: linear-gradient(135deg, #28a745, #20c997);
    border: none;
    color: white;
    padding: 0.75rem 2rem;
    border-radius: 25px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-download-template:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
    color: white;
}

.btn-import {
    background: linear-gradient(135deg, #667eea, #764ba2);
    border: none;
    color: white;
    padding: 0.75rem 2rem;
    border-radius: 25px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-import:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    color: white;
}

.instruction-card {
    background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
    border: none;
    border-radius: 15px;
    margin-bottom: 2rem;
}

.instruction-header {
    background: linear-gradient(135deg, #2196f3, #9c27b0);
    color: white;
    border-radius: 15px 15px 0 0;
    padding: 1rem 1.5rem;
}

.quiz-selector {
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    padding: 1rem;
    margin-bottom: 1.5rem;
}

.file-info {
    background: #e8f5e8;
    border: 1px solid #c3e6c3;
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1rem;
    display: none;
}
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <!-- Instruções -->
        <div class="card instruction-card">
            <div class="card-header instruction-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Como Usar a Importação de Perguntas
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-file-excel text-success me-2"></i>Formatos Suportados:</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-check text-success me-2"></i>Excel (.xlsx, .xls)</li>
                            <li><i class="fas fa-check text-success me-2"></i>CSV (.csv)</li>
                        </ul>
                        
                        <h6 class="mt-3"><i class="fas fa-question-circle text-info me-2"></i>Tipos de Pergunta:</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-check text-info me-2"></i><strong>multipla_escolha</strong> - Para questões de múltipla escolha</li>
                            <li><i class="fas fa-check text-info me-2"></i><strong>verdadeiro_falso</strong> - Para questões V/F</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-exclamation-triangle text-warning me-2"></i>Regras Importantes:</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-arrow-right text-warning me-2"></i>Múltipla escolha: mínimo 2 alternativas</li>
                            <li><i class="fas fa-arrow-right text-warning me-2"></i>Apenas 1 alternativa correta por pergunta</li>
                            <li><i class="fas fa-arrow-right text-warning me-2"></i>V/F: usar coluna "resposta_correta"</li>
                            <li><i class="fas fa-arrow-right text-warning me-2"></i>Colunas obrigatórias: pergunta, tipo</li>
                        </ul>
                    </div>
                </div>
                
                <div class="text-center mt-3">
                    <a href="{% url 'download_template' %}" class="btn btn-download-template">
                        <i class="fas fa-download me-2"></i>
                        Baixar Template de Exemplo
                    </a>
                </div>
            </div>
        </div>

        <!-- Formulário de Importação -->
        <div class="card import-card">
            <div class="card-header import-header">
                <h4 class="mb-0">
                    <i class="fas fa-upload me-2"></i>
                    Importar Perguntas
                </h4>
                <p class="mb-0 mt-2">Selecione o quiz e faça upload da sua planilha</p>
            </div>
            <div class="card-body p-4">
                <form method="post" enctype="multipart/form-data" id="importForm">
                    {% csrf_token %}
                    
                    <!-- Seletor de Quiz -->
                    <div class="quiz-selector">
                        <label class="form-label">
                            <i class="fas fa-list me-2"></i>
                            <strong>Selecionar Quiz:</strong>
                        </label>
                        {% if quiz %}
                            <input type="hidden" name="quiz_id" value="{{ quiz.id }}">
                            <div class="alert alert-info mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                As perguntas serão importadas para o quiz: <strong>{{ quiz.titulo }}</strong>
                            </div>
                        {% else %}
                            <select name="quiz_id" class="form-select" required>
                                <option value="">Selecione um quiz...</option>
                                {% for q in quizzes %}
                                    <option value="{{ q.id }}">{{ q.titulo }} ({{ q.perguntas.count }} perguntas)</option>
                                {% endfor %}
                            </select>
                        {% endif %}
                    </div>

                    <!-- Upload Zone -->
                    <div class="upload-zone" id="uploadZone">
                        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                        <h5>Arraste e solte seu arquivo aqui</h5>
                        <p class="text-muted mb-3">ou clique para selecionar</p>
                        <input type="file" name="arquivo" id="fileInput" accept=".xlsx,.xls,.csv" required style="display: none;">
                        <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('fileInput').click();">
                            <i class="fas fa-folder-open me-2"></i>
                            Selecionar Arquivo
                        </button>
                    </div>

                    <!-- Informações do Arquivo -->
                    <div class="file-info" id="fileInfo">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-file-excel text-success fa-2x me-3"></i>
                            <div>
                                <strong id="fileName"></strong><br>
                                <small class="text-muted" id="fileSize"></small>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-danger ms-auto" onclick="clearFile()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Botões -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="{% if quiz %}{% url 'pergunta_list' quiz.id %}{% else %}{% url 'quiz_list' %}{% endif %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>
                            Voltar
                        </a>
                        <button type="submit" class="btn btn-import" id="submitBtn" disabled>
                            <i class="fas fa-upload me-2"></i>
                            Importar Perguntas
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Exemplo de Formato -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-table me-2"></i>
                    Exemplo de Formatação da Planilha
                </h5>
            </div>
            <div class="card-body">
                <div class="format-example">
                    <p class="mb-3"><strong>Estrutura das colunas:</strong></p>
                    <div class="table-responsive">
                        <table class="table table-bordered format-table">
                            <thead>
                                <tr>
                                    <th>pergunta</th>
                                    <th>tipo</th>
                                    <th>alternativa_1</th>
                                    <th>alternativa_1_correta</th>
                                    <th>alternativa_2</th>
                                    <th>alternativa_2_correta</th>
                                    <th>alternativa_3</th>
                                    <th>alternativa_3_correta</th>
                                    <th>resposta_correta</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Qual é a capital do Brasil?</td>
                                    <td>multipla_escolha</td>
                                    <td>São Paulo</td>
                                    <td>false</td>
                                    <td>Brasília</td>
                                    <td>true</td>
                                    <td>Rio de Janeiro</td>
                                    <td>false</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>Django é um framework Python?</td>
                                    <td>verdadeiro_falso</td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td>verdadeiro</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h6 class="text-primary">Para Múltipla Escolha:</h6>
                            <ul class="small">
                                <li>Use colunas alternativa_1, alternativa_2, etc.</li>
                                <li>Marque a correta com "true" na coluna correspondente</li>
                                <li>Deixe "resposta_correta" vazia</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-success">Para Verdadeiro/Falso:</h6>
                            <ul class="small">
                                <li>Deixe as colunas de alternativas vazias</li>
                                <li>Use "verdadeiro" ou "falso" em "resposta_correta"</li>
                                <li>Aceita também: true/false, 1/0, sim/não</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const submitBtn = document.getElementById('submitBtn');

    // Drag and drop functionality
    uploadZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadZone.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            showFileInfo(files[0]);
        }
    });

    // File input change
    fileInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            showFileInfo(e.target.files[0]);
        }
    });

    function showFileInfo(file) {
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        fileInfo.style.display = 'block';
        submitBtn.disabled = false;
        
        // Hide upload zone
        uploadZone.style.display = 'none';
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    window.clearFile = function() {
        fileInput.value = '';
        fileInfo.style.display = 'none';
        uploadZone.style.display = 'block';
        submitBtn.disabled = true;
    };

    // Form submission
    document.getElementById('importForm').addEventListener('submit', function(e) {
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Importando...';
        submitBtn.disabled = true;
    });
});
</script>
{% endblock %}